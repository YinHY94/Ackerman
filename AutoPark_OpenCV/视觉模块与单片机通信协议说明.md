# 视觉模块与单片机通信协议说明

## 数据格式
采用**定长字符串格式**通过串口发送数据，格式为：  `MSXXX\n`  
其中：

- `M`: mode,模式 (1位数字)
- `S`: sign,偏差符号位 (0=负，1=正)
- `XXX`: 偏差绝对值 (3位数字，范围000-999)
- `\n`: 结束符 (换行符)

**数据包总长度**：6字节（5字符 + 换行符）

## 数据示例
| 场景描述                 | 数据包  |
| ------------------------ | ------- |
| 模式0，偏差+50           | `01050` |
| 模式1，偏差-75           | `10075` |
| 模式3，偏差+125          | `31125` |
| 无检测时默认误差0，模式0 | `01000` |

## 模式代码说明
| 模式代码 | 模式名称     | 行为描述                 |
| -------- | ------------ | ------------------------ |
| 0        | Approaching1 | 接近阶段（第一个车库前） |
| 1        | Approaching2 | 接近阶段（第二个车库前） |
| 2        | Approaching3 | 接近阶段（第三个车库前） |
| 3        | Backing      | 倒车入库阶段             |

## 误差值说明
- **计算方式**：  
  `误差 = 车道线中心偏差 + 1/4点偏差 - 3/4点偏差`  
  
- **方向约定**（需要根据实际调整）：
  - **正值**：建议向右调整
  - **负值**：建议向左调整

## 通信参数
- **波特率**: 115200
- **数据位**: 8
- **停止位**: 1
- **校验位**: 无

## 解析代码建议（伪代码）
```c
#include <ctype.h>

#define PACKET_SIZE 6  // 协议长度 MSXXX\n

uint8_t uart_rx_buffer[PACKET_SIZE];

void uart_idle_callback(void) {
    // 组合校验：长度、结束符、数字合法性
    if (uart_rx_buffer[5] != '\n' ||         // 结束符校验
        uart_rx_buffer[0] > '3' ||           // 模式0-3
        uart_rx_buffer[1] > '1' ||           // 符号0/1
        !isdigit(uart_rx_buffer[2]) ||       // 数值校验
        !isdigit(uart_rx_buffer[3]) || 
        !isdigit(uart_rx_buffer[4])) {
        return; // 丢弃非法数据
    }

    // 解析数据
    int16_t mode = uart_rx_buffer[0]-'0'
    
    int16_t error = (uart_rx_buffer[1] == '1' ? 1 : -1) *  // 符号
                   ((uart_rx_buffer[2]-'0')*100 +          // 百位
                    (uart_rx_buffer[3]-'0')*10 +           // 十位
                    (uart_rx_buffer[4]-'0'));              // 个位

}